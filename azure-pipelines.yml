trigger:
  branches:
    include:
      - '*'

# Enable PR triggers
pr:
  branches:
    include:
      - dev-k8s
      - qa-k8s
      - uat-k8s
      - prod-k8s

pool:
  vmImage: ubuntu-latest

resources:
  repositories:
    - repository: templates
      type: git
      name: Infraestructura-DevOps/devops_util_pipeline
      # ref: refs/heads/feature/trivy

stages:
# ============================================
# PR VALIDATION STAGES (Run only on PRs)
# ============================================

- stage: PR_Tests_and_SonarQube
  displayName: 'PR - Tests & SonarQube Analysis'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  jobs:
  - job: SonarQube_Analysis
    displayName: 'Run Tests and SonarQube'
    
    steps:
    - template: pipeline-base-maven.yml@templates
      parameters:
        COVERAGE: 'true'
    
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/target/surefire-reports/TEST-*.xml'
        failTaskOnFailedTests: true
        testRunTitle: 'Unit Tests - PR Validation'
      condition: always()
    
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Code Coverage'
      inputs:
        codeCoverageTool: 'JaCoCo'
        summaryFileLocation: '**/target/site/jacoco/jacoco.xml'
        reportDirectory: '**/target/site/jacoco'
      condition: always()
        
    - template: sonarqube-analysis.yml@templates
      parameters:
        SONAR_CONN: 'SONAR_GAL'

    - script: |
        echo "Esperando resultados de SonarQube..."
        sleep 10

        echo "Consultando estado del Quality Gate..."

        STATUS=$(curl -s -u "$(SONAR_TOKEN):" \
          "$(SONAR_URL)/api/qualitygates/project_status?projectKey=368_-_GAL_rdt_ms_afiliaciones_gal_AY-b-5oUMyPRr7E_rVIE" \
        | jq -r '.projectStatus.status')

        echo "Estado del Quality Gate: $STATUS"

        if [ "$STATUS" != "OK" ]; then
          echo "❌ Quality Gate falló. Abortando pipeline."
          exit 1
        fi

        echo "✅ Quality Gate aprobado."
      displayName: 'Validar Quality Gate en SonarQube'
      env:
        SONAR_TOKEN: $(SONAR_TOKEN)
        SONAR_GAL: $(SONAR_URL)
      failOnStderr: true

- stage: PR_Liquibase_Validate_and_Update
  displayName: 'PR - Liquibase Validate & Update'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  dependsOn: PR_Tests_and_SonarQube
  jobs:
  - job: Liquibase_Validate_Update
    displayName: 'Validate and Update DB (Dev)'
    variables:
    - group: DEV
    steps:
    - script: |
        echo "Setting up SSH tunnel to RDS..."
        
        # Create .ssh directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Decode base64-encoded SSH key and write to file
        echo "$(BASTION_SSH_KEY_BASE64)" | base64 -d > ~/.ssh/bastion_key.pem
        chmod 600 ~/.ssh/bastion_key.pem
        
        # Start SSH tunnel in background
        ssh -i ~/.ssh/bastion_key.pem \
          -N -f \
          -L 5432:$(RDS_PRIVATE_HOST):5432 \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ServerAliveInterval=60 \
          -o ServerAliveCountMax=3 \
          $(BASTION_USER)@$(BASTION_HOST)
        
        sleep 2
        
        # Verify tunnel is running
        if ps aux | grep -v grep | grep "ssh.*5432" > /dev/null; then
          echo "✅ SSH tunnel established"
        else
          echo "❌ SSH tunnel failed"
          exit 1
        fi
        
        # Clean up key file
        rm -f ~/.ssh/bastion_key.pem
      displayName: 'Setup SSH Tunnel to RDS'
      env:
        BASTION_SSH_KEY_BASE64: $(BASTION_SSH_KEY_BASE64)
    
    - task: Maven@3
      displayName: 'Liquibase Validate'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'liquibase:validate'
        options: '-P$(DB_ENV) -Dspring.datasource.url=$(DB_JDBC_URL) -Dspring.datasource.username=$(DB_USERNAME) -Dspring.datasource.password=$(DB_PASSWORD) -Dmaven.test.skip=true -Dmaven.compiler.skip=true'
        publishJUnitResults: false

    - task: Maven@3
      displayName: 'Liquibase Update'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'liquibase:update'
        options: '-P$(DB_ENV) -Dspring.datasource.url=$(DB_JDBC_URL) -Dspring.datasource.username=$(DB_USERNAME) -Dspring.datasource.password=$(DB_PASSWORD) -Dmaven.test.skip=true -Dmaven.compiler.skip=true'
        publishJUnitResults: false

# ============================================
# POST-MERGE STAGES (Run only after PR merge)
# ============================================

- stage: PostMerge_Build_Docker
  displayName: 'Post-Merge - Build & Push Docker'
  condition: ne(variables['Build.Reason'], 'PullRequest')
  jobs: 
  - job: Build_Docker 
    displayName: 'Build and Push Docker Image'
    steps:
    # - task: DownloadPipelineArtifact@2
    #   inputs:
    #     artifactName: 'artifact'
    #     targetPath: $(Build.SourcesDirectory)

    - script: |
          docker logout
          aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
      displayName: 'Login to AWS'
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    - template: steps-docker-ecr.yml@templates
      parameters:
        AWS_CREDENTIALS: '368-GAL'
        REPOSITORY_NAME: $(DOCKER_REPOSITORY_NAME_DEVK8S)
        AWS_REGION: $(AWS_REGION)
