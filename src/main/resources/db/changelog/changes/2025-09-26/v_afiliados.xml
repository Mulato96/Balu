<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="src/main/resources/db/changelog/changes/2025-09-26/v_afiliados.xml" xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet author="andual (generated)" id="1758925048792-1">
        <createView fullDefinition="false" viewName="v_afiliados">SELECT ad.identification_type AS tipodoc,
    ad.identification_number AS idpersona,
    ad.first_name AS nombre1,
    ad.second_name AS nombre2,
    ad.surname AS apellido1,
    ad.second_surname AS apellido2,
    to_char((ad.date_of_birth)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechanacimiento,
    ad.gender AS sexo,
    ad.email AS emailpersona,
    ad.phone1 AS telefonopersona,
    ad.address AS direccion,
    ad.id_department AS iddepartamento,
    dep.nombre_departamento AS departamento,
    COALESCE((NULLIF((mun.codigo_municipio)::text, ''::text))::integer, ad.id_city_municipality) AS idmunicipio,
    mun.nombre_municipio AS municipio,
    ad.id_occupation AS idocupacion,
    occ.nombre_ocupacion AS ocupacion,
    (ad.pension_fund_administrator)::integer AS afp,
    afp.nombre_afp AS nombreafp,
    hpe.codigoeps AS eps,
    hpe.nombreeps,
    ad.occupational_risk_manager AS idarl,
    arl.administradora AS nombrearl,
    NULL::text AS idacteconomica,
    ea.description AS nomacteco,
    (NULLIF((ea.class_risk)::text, ''::text))::integer AS idsectoreconomico,
    ad.salary AS salario,
    'Dependiente'::text AS nomvinlaboral,
        CASE
            WHEN ((ad.id_bonding_type = 1) AND (ad.economic_activity_code = ANY (ARRAY['1970001'::text, '3869201'::text, '1970002'::text, '3970001'::text]))) THEN 1
            WHEN (ad.id_bonding_type = 2) THEN 34
            WHEN (ad.id_bonding_type = 3) THEN 35
            WHEN (ad.id_bonding_type = 4) THEN 0
            ELSE 3
        END AS idtipovinculado,
    1 AS idsucursal,
    to_char((a.coverage_start_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechainiciovinculacion,
    to_char((a.retirement_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechafinvinculacion,
    to_char((a.coverage_start_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechaafiliacionefectiva,
    ea_aff.document_type_company AS tpdocempresa,
    ea_aff.nit_company AS idempresa,
    ea_aff.company AS razonsocial,
        CASE ea_aff.affiliation_status
            WHEN 'Activa'::text THEN 'Activo'::character varying
            WHEN 'Inactiva'::text THEN 'Inactivo'::character varying
            ELSE ea_aff.affiliation_status
        END AS estadorl,
        CASE ea_aff.affiliation_status
            WHEN 'Activa'::text THEN 'Activo'::character varying
            WHEN 'Inactiva'::text THEN 'Inactivo'::character varying
            ELSE ea_aff.affiliation_status
        END AS estadoempresa,
    'BALU'::text AS appsource,
    ad.id AS sort_order
   FROM (((((((((affiliation_dependent ad
     JOIN affiliate a ON ((ad.filed_number = (a.filed_number)::text)))
     LEFT JOIN affiliate ea_aff ON ((ad.id_affiliate_employer = ea_aff.id_affiliate)))
     LEFT JOIN tmp_departamentos dep ON ((ad.id_department = dep.id_departamento)))
     LEFT JOIN tmp_municipality mun ON ((ad.id_city_municipality = mun.id_municipio)))
     LEFT JOIN tmp_ocupaciones occ ON ((ad.id_occupation = occ.id_ocupacion)))
     LEFT JOIN tmp_fondos_pensiones afp ON ((ad.pension_fund_administrator = afp.id_afp)))
     LEFT JOIN tmp_health hpe ON ((ad.health_promoting_entity = hpe.id)))
     LEFT JOIN tmp_arl arl ON ((ad.occupational_risk_manager = (arl.codigo)::text)))
     LEFT JOIN economic_activity ea ON ((ad.economic_activity_code = (ea.economic_activity_code)::text)))
UNION ALL
 SELECT aff.identification_document_type AS tipodoc,
    aff.identification_document_number AS idpersona,
    aff.first_name AS nombre1,
    aff.second_name AS nombre2,
    aff.surname AS apellido1,
    aff.second_surname AS apellido2,
    to_char((aff.date_of_birth)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechanacimiento,
    aff.gender AS sexo,
    aff.email AS emailpersona,
    aff.phone_1 AS telefonopersona,
    aff.address AS direccion,
    (NULLIF((aff.department)::text, ''::text))::integer AS iddepartamento,
    dep.nombre_departamento AS departamento,
    COALESCE((NULLIF((mun.codigo_municipio)::text, ''::text))::integer, (NULLIF((aff.city_municipality)::text, ''::text))::integer) AS idmunicipio,
    mun.nombre_municipio AS municipio,
    NULL::integer AS idocupacion,
    aff.occupation AS ocupacion,
    (aff.pension_fund_administrator)::integer AS afp,
    afp.nombre_afp AS nombreafp,
    hpe.codigoeps AS eps,
    hpe.nombreeps,
    aff.current_arl AS idarl,
    arl.administradora AS nombrearl,
    NULL::text AS idacteconomica,
    ea.description AS nomacteco,
    (NULLIF((ea.class_risk)::text, ''::text))::integer AS idsectoreconomico,
    aff.contract_monthly_value AS salario,
    'Independiente'::text AS nomvinlaboral,
    0 AS idtipovinculado,
    1 AS idsucursal,
    to_char((aff.contract_start_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechainiciovinculacion,
    to_char((aff.contract_end_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechafinvinculacion,
    to_char((a.coverage_start_date)::timestamp with time zone, 'YYYY-MM-DD HH24:MI:SS'::text) AS fechaafiliacionefectiva,
    COALESCE(aff.identification_document_type_legal_representative, a.document_type_company) AS tpdocempresa,
    COALESCE(am.number_identification, aff.identification_document_number_contractor, a.nit_company) AS idempresa,
    COALESCE(am.business_name, a.company) AS razonsocial,
        CASE COALESCE(am.affiliation_status, a.affiliation_status)
            WHEN 'Activa'::text THEN 'Activo'::character varying
            WHEN 'Inactiva'::text THEN 'Inactivo'::character varying
            ELSE COALESCE(am.affiliation_status, a.affiliation_status)
        END AS estadorl,
        CASE COALESCE(am.affiliation_status, a.affiliation_status)
            WHEN 'Activa'::text THEN 'Activo'::character varying
            WHEN 'Inactiva'::text THEN 'Inactivo'::character varying
            ELSE COALESCE(am.affiliation_status, a.affiliation_status)
        END AS estadoempresa,
    'BALU'::text AS appsource,
    aff.id AS sort_order
   FROM ((((((((affiliation_detail aff
     JOIN affiliate a ON (((aff.filed_number)::text = (a.filed_number)::text)))
     LEFT JOIN tmp_departamentos dep ON (((NULLIF((aff.department)::text, ''::text))::integer = dep.id_departamento)))
     LEFT JOIN tmp_municipality mun ON (((NULLIF((aff.city_municipality)::text, ''::text))::integer = mun.id_municipio)))
     LEFT JOIN tmp_fondos_pensiones afp ON ((aff.pension_fund_administrator = afp.id_afp)))
     LEFT JOIN tmp_health hpe ON ((aff.health_promoting_entity = hpe.id)))
     LEFT JOIN tmp_arl arl ON (((aff.current_arl)::text = (arl.codigo)::text)))
     LEFT JOIN economic_activity ea ON ((aff.code_main_economic_activity = (ea.economic_activity_code)::text)))
     LEFT JOIN affiliate_mercantile am ON ((((aff.identification_document_type_contractor)::text = (am.type_document_identification)::text) AND ((aff.identification_document_number_contractor)::text = (am.number_identification)::text))));</createView>
    </changeSet>
</databaseChangeLog>
